# Book Service

Микросервис для управления книгами и профилями авторов в системе каталога книг.

## Описание

Этот сервис является частью микросервисной архитектуры и отвечает за:
- CRUD операции с книгами
- CRUD операции с профилями авторов
- Поиск книг по различным критериям
- Работу с файлами книг (PDF)
- Управление статусами книг и авторов

## Архитектура

### Роли пользователей
- **Guest** - неавторизованные пользователи
- **User** - авторизованные пользователи
- **Admin** - администраторы

### Статусы книг
- **ON_MODERATE** - на модерации
- **ACTIVE** - активная
- **PRIVATE** - приватная
- **BLOCKED** - заблокированная
- **ON_APILATION** - на рассмотрении

### Статусы профилей авторов
- **ACTIVE** - активный
- **PRIVATE** - приватный
- **BLOCKED** - заблокированный
- **ON_APILATION** - на рассмотрении

## API Endpoints

### Книги (Books)

#### Создание книги
```
POST /books/
```
Создает новую книгу с файлом PDF. Требует авторизации (роли: User, Admin).

**Параметры:**
- `title` (string) - название книги
- `description` (string, optional) - описание
- `genres` (string, optional) - жанры через запятую
- `issued_date` (string, optional) - дата выпуска (YYYY-MM-DD)
- `file` (file) - PDF файл книги

#### Получение книги
```
GET /books/{book_id}
```
Получает книгу по ID. Доступно всем ролям.

#### Обновление книги
```
PUT /books/{book_id}
```
Обновляет книгу. Требует авторизации (роли: User, Admin).

**Параметры:**
- `title` (string, optional) - название книги
- `description` (string, optional) - описание
- `genres` (array, optional) - массив жанров
- `issued_date` (date, optional) - дата выпуска
- `status` (string, optional) - статус книги

#### Удаление книги
```
DELETE /books/{book_id}
```
Удаляет книгу. Требует авторизации (роли: User, Admin).

#### Получение книг автора
```
GET /books/author/{author_id}
```
Получает все книги автора. Доступно всем ролям.

### Профили авторов (Authors)

#### Создание профиля автора
```
POST /authors/
```
Создает новый профиль автора. Требует авторизации (роли: User, Admin).

**Параметры:**
- `name` (string) - имя автора
- `common_genres` (array, optional) - основные жанры
- `status` (string, optional) - статус профиля

#### Получение профиля автора
```
GET /authors/{author_id}
```
Получает профиль автора по ID. Доступно всем ролям.

#### Получение профиля по ID пользователя
```
GET /authors/user/{user_id}
```
Получает профиль автора по ID пользователя. Доступно всем ролям.

#### Обновление профиля автора
```
PUT /authors/{author_id}
```
Обновляет профиль автора. Требует авторизации (роли: User, Admin).

#### Удаление профиля автора
```
DELETE /authors/{author_id}
```
Удаляет профиль автора. Требует авторизации (роли: User, Admin).

#### Получение всех профилей авторов
```
GET /authors/
```
Получает все профили авторов. Доступно всем ролям.

### Поиск книг

```
GET /search/books
```
Поиск книг по различным критериям. Доступно всем ролям.

**Параметры поиска:**
- `book_rating_min/max` - рейтинг книги
- `author_rating_min/max` - рейтинг автора
- `reviews_count_min/max` - количество отзывов
- `book_likes_min/max` - лайки книги
- `author_likes_min/max` - лайки автора
- `author_books_min/max` - количество книг у автора
- `book_genres` - жанры книги (через запятую)
- `author_genres` - жанры автора (через запятую)
- `issued_date_from/to` - дата выпуска
- `pages_min/max` - количество страниц
- `key` - поиск по названию или имени автора

**Параметры пагинации:**
- `page_number` - номер страницы (по умолчанию 1)
- `page_size` - размер страницы (по умолчанию 10, максимум 20 для не-админов)
- `sort_by` - поле для сортировки
- `sort_order` - порядок сортировки (asc/desc)

### Работа с файлами книг

#### Получение страниц книги
```
GET /books/{book_id}/pages?start_page=1&end_page=10
```
Получает диапазон страниц книги в формате PDF. Доступно всем ролям.

#### Получение одной страницы
```
GET /books/{book_id}/page/{page_number}
```
Получает одну страницу книги. Доступно всем ролям.

#### Получение полного файла
```
GET /books/{book_id}/file
```
Получает полный файл книги. Требует авторизации (роли: User, Admin).

### Управление статусами

#### Изменение статуса книги
```
PUT /status/books/{book_id}
```
Изменяет статус книги. Требует авторизации (роли: User, Admin).

**Параметры:**
- `status` (string) - новый статус

#### Изменение статуса профиля автора
```
PUT /status/authors/{author_id}
```
Изменяет статус профиля автора. Требует авторизации (роли: User, Admin).

## Авторизация

Сервис получает информацию о пользователе через заголовки HTTP, которые устанавливает API Gateway:

- `X-User-Id` - ID пользователя
- `X-User-Name` - имя пользователя
- `X-User-Role` - роль пользователя
- `X-User-Status` - статус пользователя

## Права доступа

### Книги
- **Создание**: только пользователи с профилем автора
- **Просмотр**: все роли (с учетом статуса книги)
- **Изменение/удаление**: только авторы книг или админы
- **Статусы**: админы могут ставить любые статусы, авторы - только PRIVATE/ACTIVE

### Профили авторов
- **Создание**: только авторизованные пользователи (не Guest)
- **Просмотр**: все роли (с учетом статуса профиля)
- **Изменение/удаление**: только владельцы профилей или админы
- **Статусы**: админы могут ставить любые статусы, владельцы - только PRIVATE/ACTIVE

### Файлы книг
- **Просмотр страниц**: все роли (с учетом статуса книги)
- **Полный файл**: только авторизованные пользователи
- **Ограничения**: не-админы могут получить максимум 10 страниц за запрос

## Ограничения

- Максимальный размер файла: 50MB
- Поддерживаемые форматы: PDF
- Максимум 10 жанров на книгу/автора
- Максимум 20 книг на страницу для не-админов
- Максимум 10 страниц за запрос для не-админов

## Установка и запуск

1. Установите зависимости:
```bash
poetry install
```

2. Настройте переменные окружения в `.env` файле:
```
APP_HOST=localhost
APP_PORT=8000
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_NAME=your_db_name
DB_HOST=your_db_host
DB_URL=postgresql+asyncpg://{username}:{password}@{host}/{bd_name}
```

3. Запустите сервис:
```bash
poetry run python src/main.py
```

## Зависимости

- FastAPI - веб-фреймворк
- SQLAlchemy - ORM
- AsyncPG - драйвер PostgreSQL
- PyPDF2 - работа с PDF файлами
- Pydantic - валидация данных
- Uvicorn - ASGI сервер
